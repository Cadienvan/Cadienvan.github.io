---
import { Image } from "astro:assets";

import pointerRight from "../../public/assets/pointer-right.png";
import feedRSS from "../../public/assets/feed-rss.png";

interface Props {
  lang: string;
  langIcon: string;
}

interface BlogPost {
  frontmatter: {
    title: string;
    date: string;
    lang?: string;
    hasTranslation?: boolean;
    customTranslationUrl?: string;
  };
  url: string;
}

// Link esterni che non sono file .md nel progetto
const externalLinks = [
  {
    it: {
      title: "Articoli vari @ TheRedCode.it",
      url: "https://theredcode.it/authors/michael-di-prisco/",
      date: "2023-12-19", // Data primo articolo
    },
    en: {
      title: "Various articles @ TheRedCode.it",
      url: "https://theredcode.it/authors/michael-di-prisco/",
      date: "2023-12-19",
    },
  },
];

// Carica dinamicamente tutti i blog post
const italianPosts = await Astro.glob<BlogPost["frontmatter"]>("../pages/blog/*.md");
const englishPosts = await Astro.glob<BlogPost["frontmatter"]>("../pages/blog/en/*.md");

// Crea una mappa per collegare i post italiani con le loro traduzioni inglesi
const getArticles = (lang: string) => {
  const posts = lang === "it" ? italianPosts : englishPosts;
  
  const articles = posts.map((post) => {
    const slug = post.url || "";
    return {
      title: post.frontmatter.title,
      url: slug,
      date: post.frontmatter.date,
    };
  });

  // Aggiungi i link esterni
  externalLinks.forEach((link) => {
    if (link[lang]) {
      articles.push(link[lang]);
    }
  });

  // Ordina per data (dal più recente al più vecchio)
  return articles.sort((a, b) => {
    const dateA = new Date(a.date);
    const dateB = new Date(b.date);
    return dateB.getTime() - dateA.getTime();
  });
};

const { lang, langIcon } = Astro.props;
const articles = getArticles(lang);

// Formatta la data in formato leggibile
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString(lang === "it" ? "it-IT" : "en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
};
---

<section class='nes-container with-title'>
  <h3 class='title'>Blog {langIcon}</h3>
  <h2>
    <a href={new URL(lang === "it" ? "feed-it.xml" : "feed.xml", Astro.site)}>
      <Image src={feedRSS} alt='Feed RSS' />
      <span>RSS Feed</span>
    </a>
  </h2>
  <hr />
  <div class='lists'>
    {
      articles.map((article) => (
        <h3 class="blog-article" data-date={article.date}>
          <a href={article.url}>
            <Image src={pointerRight} alt={article.title} />
            <span>{article.title}</span>
            <small class="blog-date">({formatDate(article.date)})</small>
          </a>
        </h3>
      ))
    }
  </div>
</section>

<script>
  // Hide future blog posts on the client side
  function hideFuturePosts() {
    const now = new Date();
    now.setHours(0, 0, 0, 0);
    
    document.querySelectorAll('.blog-article').forEach((article) => {
      const dateStr = article.getAttribute('data-date');
      if (dateStr) {
        const postDate = new Date(dateStr);
        postDate.setHours(0, 0, 0, 0);
        if (postDate > now) {
          (article as HTMLElement).style.display = 'none';
        }
      }
    });
  }
  
  hideFuturePosts();
</script>

<style>
  .blog-date {
    font-size: 0.7em;
    opacity: 0.7;
    margin-left: 0.5em;
  }
</style>
